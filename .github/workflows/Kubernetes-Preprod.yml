name: Kubernetes-Preprod
on:
  push:
    branches:
      - preprod
    paths:
      - ".github/workflows/Kubernetes-Preprod.yml"
      - "kubernetes/base/**"
      - "kubernetes/overlay/preprod/**"
jobs:
  Deployment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          ref: ${{ github.ref }}

      - name: Run Kustomize
        working-directory: ./kubernetes
        run: kubectl kustomize overlay/preprod > replaybot-preprod.yml

      - name: Commit to platform repo
        uses: leigholiver/commit-with-deploy-key@v1.0.0
        with:
          source: kubernetes/replaybot-preprod.yml
          destination_folder: resources/replaybot
          destination_repo: leigholiver/platform
          deploy_key: ${{ secrets.DEPLOY_KEY }}
