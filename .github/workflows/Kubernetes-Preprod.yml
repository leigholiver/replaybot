name: Kubernetes-Preprod
on:
  push:
    branches:
      - preprod
    paths:
      - ".github/workflows/Kubernetes-Preprod.yml"
      - "kubernetes/base/**"
      - "kubernetes/overlay/preprod/**"
jobs:
  Deployment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          ref: ${{ github.ref }}

      - name: Run Kustomize
        working-directory: ./kubernetes
        run: kubectl kustomize overlay/preprod > replaybot-preprod.yml

      - name: Commit to platform repo
        uses: dmnemec/copy_file_to_another_repo_action@v1.0.4
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_TOKEN_GITHUB }}
        with:
          source_file: kubernetes/replaybot-preprod.yml
          destination_repo: leigholiver/platform
          destination_folder: resources/replaybot
          user_email: leighdoliver@gmail.com
          user_name: leigholiver
